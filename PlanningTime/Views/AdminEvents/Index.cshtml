@model List<PlanningTime.Models.Event>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<div class="container my-5">
    <h2 class="text-center mb-4 fw-bold" style="color:#343a40;">📋 Gestion des Demandes</h2>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle">
            <thead class="table-dark text-white">
                <tr>
                    <th>Employé</th>
                    <th>Type</th>
                    <th>Période</th>
                    <th>Motif</th>
                    <th>Justificatif</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in Model)
                {
                    <tr data-id="@e.Id" class="align-middle">
                        <td class="d-flex align-items-center">
                            <img src="~/images/@e.User.ImageUser"
                                 alt="@e.User.LastName"
                                 class="rounded-circle me-3"
                                 style="width:40px; height:40px; object-fit:cover;" />
                            <div>
                                <div class="fw-bold">@e.User.FirstName @e.User.LastName</div>
                                <small class="text-muted">@e.User.Profile?.Name</small>
                            </div>
                        </td>
                        <td>@e.EventType.Name</td>
                        <td>@e.StartDate.ToString("dd/MM/yyyy") - @e.EndDate.ToString("dd/MM/yyyy")</td>
                        <td>@e.Motif</td>
                        <td>
                            @if (!string.IsNullOrEmpty(e.Justificatif))
                            {
                                <a href="@e.Justificatif" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fa fa-file-alt me-1"></i> Voir
                                </a>
                            }
                        </td>
                        <td class="action-cell">
                            @if (e.Status == PlanningTime.Models.EventStatus.Pending)
                            {
                                <button class="btn btn-success btn-sm approve-btn me-2" data-id="@e.Id">
                                    <i class="fa fa-check me-1"></i> Approuver
                                </button>
                                <button class="btn btn-danger btn-sm reject-btn" data-id="@e.Id">
                                    <i class="fa fa-times me-1"></i> Rejeter
                                </button>
                            }
                            else if (e.Status == PlanningTime.Models.EventStatus.Approved)
                            {
                                <span class="badge bg-success"><i class="fa fa-check me-1"></i>Approuvé</span>
                            }
                            else if (e.Status == PlanningTime.Models.EventStatus.Rejected)
                            {
                                <span class="badge bg-danger"><i class="fa fa-times me-1"></i>Rejeté</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    table.table-hover tbody tr:hover {
        background-color: #e9f5ff;
        transition: background-color 0.3s ease;
    }

    .approve-btn:hover {
        background-color: #218838 !important;
    }

    .reject-btn:hover {
        background-color: #c82333 !important;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .badge {
        font-size: 0.9rem;
    }
</style>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        $(document).on("click", ".approve-btn, .reject-btn", function () {
            var $btn = $(this);
            var eventId = $btn.data("id");
            var approve = $btn.hasClass("approve-btn");

            $.post("/AdminEvents/Validate", { id: eventId, approve: approve }, function (res) {
                if (res.success) {
                    var $cell = $btn.closest("td.action-cell");
                    $cell.html(approve
                        ? "<span class='badge bg-success'><i class='fa fa-check me-1'></i>Approuvé</span>"
                        : "<span class='badge bg-danger'><i class='fa fa-times me-1'></i>Rejeté</span>");
                } else {
                    alert("Erreur lors de la mise à jour du statut !");
                }
            });
        });
    </script>
}
